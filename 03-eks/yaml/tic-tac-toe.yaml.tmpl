# ========================================================
# Tic-Tac-Toe Deployment
# Manages the pod lifecycle for the game application
# ========================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tic-tac-toe  # Unique identifier for this deployment

spec:
  replicas: 1  # Run exactly one instance of the game pod

  selector:  # Links the deployment to pods with these labels
    matchLabels:
      app: tic-tac-toe

  template:  # Blueprint for creating new pods
    metadata:
      labels:
        app: tic-tac-toe  # Must match selector.matchLabels

    spec:
      nodeSelector:  # Constrains pods to nodes with this label
        nodegroup: game-nodes

      containers:
        - name: tic-tac-toe  # Container name (visible in logs/dashboard)
          image: ${account_id}.dkr.ecr.us-east-2.amazonaws.com/games:tic-tac-toe-rc1  # ECR image location
          ports:
            - containerPort: 8000  # The port the game server listens on

---
# ========================================================
# Tic-Tac-Toe Service
# Provides stable network access to the game pods
# ========================================================
apiVersion: v1
kind: Service
metadata:
  name: tic-tac-toe-service  # DNS name for internal cluster access

spec:
  selector:  # Routes traffic to pods with this label
    app: tic-tac-toe

  ports:
    - protocol: TCP  # Standard protocol for HTTP traffic
      port: 80  # External service port
      targetPort: 8000  # Forwards to container's port 8000

---
# ========================================================
# Tic-Tac-Toe Ingress
# Manages external HTTP access to the service
# ========================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tic-tac-toe-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    nginx.ingress.kubernetes.io/permanent-redirect: /games/tic-tac-toe/
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          # Redirect /games/tic-tac-toe â†’ /games/tic-tac-toe/
          - path: /games/tic-tac-toe
            pathType: Exact
            backend:
              service:
                name: tic-tac-toe-service
                port:
                  number: 80

          # Route /games/tic-tac-toe/ and everything under it
          - path: /games/tic-tac-toe/(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: tic-tac-toe-service
                port:
                  number: 80
